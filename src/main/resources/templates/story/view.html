<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Read Story</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/custom.css}" rel="stylesheet">
    <!-- Audio libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>
<!-- Floating Elements -->
<div class="floating-elements">
    <div class="floating-element cloud1">‚òÅÔ∏è</div>
    <div class="floating-element cloud2">‚òÅÔ∏è</div>
    <div class="floating-element star1">‚≠ê</div>
    <div class="floating-element star2">‚ú®</div>
    <div class="floating-element cloud3">‚òÅÔ∏è</div>
    <div class="floating-element star3">‚ú®</div>
</div>

<button onclick="toggleTheme()" class="btn theme-switch">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<div class="container mt-5">
    <div class="story-container">
        <h2 th:text="${story.title}" class="mb-4 story-title">Story Title</h2>

        <div class="story-pages view-mode">
            <div th:each="page, stat : ${story.pages}"
                 th:class="${stat.first ? 'story-page active' : 'story-page'}"
                 th:id="'page-' + ${stat.index}">

                <!-- Updated Image Display -->
                <img th:if="${page.imageData != null}"
                     th:src="@{/stories/image/{id}(id=${page.id})}"
                     class="story-image"
                     alt="Story illustration">

                <p class="story-text fs-4" th:text="${page.text}">Page text</p>
            </div>
        </div>
    </div>
</div>

<!-- Navigation buttons with enhanced styling -->
<div class="navigation-buttons">
    <button onclick="previousPage()" class="btn btn-secondary" id="prevBtn" disabled>
        <i class="fas fa-chevron-left"></i> Previous
    </button>

    <button onclick="toggleReadAloud()" class="btn btn-primary read-aloud-btn" id="readBtn">
        <i class="fas fa-volume-up"></i> Read Aloud
    </button>

    <span class="page-indicator">
        Page <span id="currentPage">1</span> of <span th:text="${story.pages.size()}">5</span>
    </span>

    <button onclick="nextPage()" class="btn btn-primary" id="nextBtn">
        Next <i class="fas fa-chevron-right"></i>
    </button>

    <a th:href="@{/stories}" class="btn btn-success" id="exitBtn" style="display: none;">
        <i class="fas fa-check"></i> The End!
    </a>
</div>

<!-- Interactive Story Elements Button -->
<div class="magic-corner">
    <button onclick="toggleMagicMenu()" class="btn magic-trigger">
        <i class="fas fa-magic"></i>
    </button>
    <div class="magic-menu" id="magicMenu">
        <button class="magic-item" onclick="createShower('‚≠ê')">
            <i class="fas fa-star"></i>
        </button>
        <button class="magic-item" onclick="createShower('‚ù§Ô∏è')">
            <i class="fas fa-heart"></i>
        </button>
        <button class="magic-item" onclick="createShower('üéà')">
            <i class="fas fa-birthday-cake"></i>
        </button>
        <button class="magic-item" onclick="createShower('üåà')">
            <i class="fas fa-rainbow"></i>
        </button>
    </div>
</div>

<!-- Particle Container -->
<div id="particle-container"></div>

<script th:inline="javascript">
    let currentPageIndex = 0;
    const totalPages = [[${story.pages.size()}]];
    let speech = null;
    let magicMenuOpen = false;

    function showPage(index) {
        // Create a page turn effect
        const pageElement = document.getElementById('page-' + index);

        // Stop any ongoing speech
        stopReading();

        // Hide all pages
        document.querySelectorAll('.story-page').forEach(page => {
            page.classList.remove('active');
        });

        // Show the selected page with animation
        pageElement.style.opacity = '0';
        pageElement.classList.add('active');

        setTimeout(() => {
            pageElement.style.opacity = '1';
            pageElement.style.transform = 'translateY(0)';
        }, 50);

        // Update navigation buttons
        document.getElementById('prevBtn').disabled = index === 0;
        document.getElementById('nextBtn').style.display = index === totalPages - 1 ? 'none' : 'inline-block';
        document.getElementById('exitBtn').style.display = index === totalPages - 1 ? 'inline-block' : 'none';

        // Update page indicator
        document.getElementById('currentPage').textContent = index + 1;

        // If it's the last page, celebrate
        if (index === totalPages - 1) {
            setTimeout(() => {
                createShower('‚≠ê');
                playSound('twinkle');
            }, 500);
        }
    }

    function nextPage() {
        if (currentPageIndex < totalPages - 1) {
            const oldPage = document.getElementById('page-' + currentPageIndex);
            oldPage.style.transform = 'translateX(-100px)';
            oldPage.style.opacity = '0';

            currentPageIndex++;

            const newPage = document.getElementById('page-' + currentPageIndex);
            newPage.style.transform = 'translateX(100px)';

            // Play page turn sound
            playSound('page-turn');

            setTimeout(() => {
                showPage(currentPageIndex);
            }, 300);
        }
    }

    function previousPage() {
        if (currentPageIndex > 0) {
            const oldPage = document.getElementById('page-' + currentPageIndex);
            oldPage.style.transform = 'translateX(100px)';
            oldPage.style.opacity = '0';

            currentPageIndex--;

            const newPage = document.getElementById('page-' + currentPageIndex);
            newPage.style.transform = 'translateX(-100px)';

            // Play page turn sound
            playSound('page-turn');

            setTimeout(() => {
                showPage(currentPageIndex);
            }, 300);
        }
    }

    function toggleReadAloud() {
        const readBtn = document.getElementById('readBtn');
        if (speech && window.speechSynthesis.speaking) {
            stopReading();
        } else {
            const currentText = document.querySelector('.story-page.active .story-text').textContent;
            startReading(currentText);
            readBtn.classList.add('playing');

            // Visual indication that reading is happening
            createTinyShower('üí¨', 3, true);
        }
    }

    function startReading(text) {
        speech = new SpeechSynthesisUtterance(text);
        speech.onend = () => {
            const readBtn = document.getElementById('readBtn');
            readBtn.classList.remove('playing');
        };
        window.speechSynthesis.speak(speech);
    }

    function stopReading() {
        if (speech) {
            window.speechSynthesis.cancel();
            const readBtn = document.getElementById('readBtn');
            readBtn.classList.remove('playing');
        }
    }

    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('themeIcon');

        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            icon.classList.replace('fa-sun', 'fa-moon');
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
            localStorage.setItem('theme', 'dark');
        }
    }

    function toggleMagicMenu() {
        const menu = document.getElementById('magicMenu');
        magicMenuOpen = !magicMenuOpen;

        if (magicMenuOpen) {
            menu.style.display = 'flex';
            setTimeout(() => {
                menu.style.opacity = '1';
                menu.style.transform = 'scale(1)';
            }, 10);
        } else {
            menu.style.opacity = '0';
            menu.style.transform = 'scale(0.5)';
            setTimeout(() => {
                menu.style.display = 'none';
            }, 300);
        }
    }

    function createShower(emoji) {
        const container = document.getElementById('particle-container');
        const count = 20 + Math.floor(Math.random() * 10); // Between 20-30 particles

        // Clear existing particles if there are too many
        if (container.children.length > 100) {
            container.innerHTML = '';
        }

        // Play a fun sound effect
        const audioEffects = {
            '‚≠ê': 'twinkle',
            '‚ù§Ô∏è': 'pop',
            'üéà': 'balloon',
            'üåà': 'magic'
        };

        playSound(audioEffects[emoji] || 'pop');

        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = emoji;

            // Random position from click or center if no event
            const startX = 40 + Math.random() * (window.innerWidth - 80);
            const startY = window.innerHeight;

            // Random end position
            const endX = startX + (Math.random() - 0.5) * 300;
            const endY = 100 + Math.random() * 400;

            // Random sizes - much larger now
            const size = 40 + Math.random() * 60;

            // Set styles
            particle.style.left = startX + 'px';
            particle.style.top = startY + 'px';
            particle.style.fontSize = size + 'px';

            // Add to container
            container.appendChild(particle);

            // Animate upward
            setTimeout(() => {
                particle.style.transform = `translate(${endX - startX}px, ${endY - startY}px) rotate(${Math.random() * 360}deg)`;
                particle.style.opacity = '0';
            }, 10);

            // Remove after animation completes
            setTimeout(() => {
                if (container.contains(particle)) {
                    container.removeChild(particle);
                }
            }, 3000);
        }
    }

    function createTinyShower(emoji, count = 5, nearButton = false) {
        const container = document.getElementById('particle-container');

        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle tiny';
            particle.textContent = emoji;

            let startX, startY;

            if (nearButton) {
                // Position near the Read Aloud button
                const button = document.getElementById('readBtn');
                const rect = button.getBoundingClientRect();
                startX = rect.x + rect.width/2 + (Math.random() - 0.5) * 20;
                startY = rect.y;
            } else {
                startX = Math.random() * window.innerWidth;
                startY = Math.random() * window.innerHeight;
            }

            // Random end position
            const endX = startX + (Math.random() - 0.5) * 100;
            const endY = startY - 50 - Math.random() * 50;

            // Set styles
            particle.style.left = startX + 'px';
            particle.style.top = startY + 'px';
            particle.style.fontSize = 20 + Math.random() * 10 + 'px';

            // Add to container
            container.appendChild(particle);

            // Animate upward
            setTimeout(() => {
                particle.style.transform = `translate(${endX - startX}px, ${endY - startY}px) rotate(${Math.random() * 30}deg)`;
                particle.style.opacity = '0';
            }, 10);

            // Remove after animation completes
            setTimeout(() => {
                if (container.contains(particle)) {
                    container.removeChild(particle);
                }
            }, 2000);
        }
    }

    function playSound(type) {
        // Create audio elements with different sounds
        let soundUrl;

        switch(type) {
            case 'twinkle':
                soundUrl = 'https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/sounds/success.mp3';
                break;
            case 'pop':
                soundUrl = 'https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/sounds/click.mp3';
                break;
            case 'balloon':
                soundUrl = 'https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/sounds/notification.mp3';
                break;
            case 'magic':
                soundUrl = 'https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/sounds/toggle.mp3';
                break;
            case 'page-turn':
                soundUrl = 'https://cdn.jsdelivr.net/gh/Leimi/SoundButton@master/sounds/sfx_sounds_page-turn-01a.mp3';
                break;
            default:
                soundUrl = 'https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/sounds/click.mp3';
        }

        // Create and play the audio
        const audio = new Audio(soundUrl);
        audio.volume = 0.4; // 40% volume
        audio.play().catch(e => console.log('Audio play failed:', e));
    }

    // Set initial theme from localStorage and initialize page
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const icon = document.getElementById('themeIcon');

        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
        }

        // Initialize first page with animation
        const firstPage = document.querySelector('.story-page.active');
        if (firstPage) {
            firstPage.style.opacity = '0';
            firstPage.style.transform = 'translateY(20px)';

            setTimeout(() => {
                firstPage.style.opacity = '1';
                firstPage.style.transform = 'translateY(0)';
            }, 300);
        }

        // Add subtle sparkle to title
        setTimeout(() => {
            createTinyShower('‚ú®', 3);
        }, 1000);
    });

    // Handle keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') nextPage();
        if (e.key === 'ArrowLeft') previousPage();
        if (e.key === ' ') {
            e.preventDefault();
            toggleReadAloud();
        }
        if (e.key === 'm') {
            toggleMagicMenu();
        }
    });

    // Close magic menu when clicking outside
    document.addEventListener('click', (e) => {
        if (magicMenuOpen && !e.target.closest('.magic-corner')) {
            toggleMagicMenu();
        }
    });
</script>
</body>
</html>