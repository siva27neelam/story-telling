<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Read Story</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/custom.css}" rel="stylesheet">
</head>
<body>
<button onclick="toggleTheme()" class="btn theme-switch">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<div class="container mt-5">
    <div class="story-container">
        <h2 th:text="${story.title}" class="mb-4">Story Title</h2>

        <!-- Added view-mode class here -->
        <div class="story-pages view-mode">
            <div th:each="page, stat : ${story.pages}"
                 th:class="${stat.first ? 'story-page active' : 'story-page'}"
                 th:id="'page-' + ${stat.index}">

                <img th:if="${page.imageUrl}" th:src="${page.imageUrl}"
                     class="story-image" alt="Story illustration">

                <p class="story-text fs-4" th:text="${page.text}">Page text</p>
            </div>
        </div>
    </div>
</div>

<div class="navigation-buttons">
    <button onclick="previousPage()" class="btn btn-secondary" id="prevBtn" disabled>
        <i class="fas fa-chevron-left"></i> Previous
    </button>

    <button onclick="toggleReadAloud()" class="btn btn-primary read-aloud-btn" id="readBtn">
        <i class="fas fa-volume-up"></i> Read Aloud
    </button>

    <span class="page-indicator">
            Page <span id="currentPage">1</span> of <span th:text="${story.pages.size()}">5</span>
        </span>

    <button onclick="nextPage()" class="btn btn-primary" id="nextBtn">
        Next <i class="fas fa-chevron-right"></i>
    </button>

    <a th:href="@{/stories}" class="btn btn-success" id="exitBtn" style="display: none;">
        <i class="fas fa-check"></i> The End!
    </a>
</div>

<script th:inline="javascript">
    let currentPageIndex = 0;
    const totalPages = [[${story.pages.size()}]];
    let speech = null;

    function showPage(index) {
        // Stop any ongoing speech
        stopReading();

        // Hide all pages
        document.querySelectorAll('.story-page').forEach(page => {
            page.classList.remove('active');
        });

        // Show the selected page
        document.getElementById('page-' + index).classList.add('active');

        // Update navigation buttons
        document.getElementById('prevBtn').disabled = index === 0;
        document.getElementById('nextBtn').style.display = index === totalPages - 1 ? 'none' : 'inline-block';
        document.getElementById('exitBtn').style.display = index === totalPages - 1 ? 'inline-block' : 'none';

        // Update page indicator
        document.getElementById('currentPage').textContent = index + 1;
    }

    function nextPage() {
        if (currentPageIndex < totalPages - 1) {
            currentPageIndex++;
            showPage(currentPageIndex);
        }
    }

    function previousPage() {
        if (currentPageIndex > 0) {
            currentPageIndex--;
            showPage(currentPageIndex);
        }
    }

    function toggleReadAloud() {
        const readBtn = document.getElementById('readBtn');
        if (speech && window.speechSynthesis.speaking) {
            stopReading();
        } else {
            const currentText = document.querySelector('.story-page.active .story-text').textContent;
            startReading(currentText);
            readBtn.classList.add('playing');
        }
    }

    function startReading(text) {
        speech = new SpeechSynthesisUtterance(text);
        speech.onend = () => {
            const readBtn = document.getElementById('readBtn');
            readBtn.classList.remove('playing');
        };
        window.speechSynthesis.speak(speech);
    }

    function stopReading() {
        if (speech) {
            window.speechSynthesis.cancel();
            const readBtn = document.getElementById('readBtn');
            readBtn.classList.remove('playing');
        }
    }

    function toggleTheme() {
        const body = document.body;
        const icon = document.getElementById('themeIcon');

        if (body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            icon.classList.replace('fa-sun', 'fa-moon');
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
            localStorage.setItem('theme', 'dark');
        }
    }

    // Set initial theme from localStorage
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const icon = document.getElementById('themeIcon');

        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            icon.classList.replace('fa-moon', 'fa-sun');
        }
    });

    // Handle keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') nextPage();
        if (e.key === 'ArrowLeft') previousPage();
        if (e.key === 'Space') {
            e.preventDefault();
            toggleReadAloud();
        }
    });
</script>
</body>
</html>